AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: SAM Template for Lambda function with Airtable and XLSX.js libraries in a layer.

Resources:
  ReonomyUploadApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod

  # Lambda Layer definition
  AirtableXLSXLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: AirtableXLSXLayer
      Description: Layer containing Airtable and XLSX libraries
      ContentUri: ./layer/
      CompatibleRuntimes:
        - nodejs16.x
        - nodejs20.x
      LicenseInfo: 'MIT'

  # Lambda Function using the layer
  ReonomyUploadFunction:
    Type: AWS::Serverless::Function
    Properties: 
      Handler: index.handler
      Runtime: nodejs20.x
      CodeUri: ./src/  # Points to the directory containing your Lambda function code
      Layers:
        - !Ref AirtableXLSXLayer  # Reference the layer created above
      MemorySize: 128
      Timeout: 10
      Policies:
        - AWSLambdaBasicExecutionRole
      Events:
        ReonomyUploadPostApi:
          Type: Api
          Properties:
            Path: /
            RestApiId: !Ref ReonomyUploadApi
            Method: POST

Outputs:
  LambdaFunction:
    Description: "The Lambda function ARN"
    Value: !Ref ReonomyUploadFunction

  LambdaLayerVersionArn:
    Description: "Lambda Layer Version ARN"
    Value: !Ref AirtableXLSXLayer

  ReonomyUploadApi:
    Description: "Api gateway url for renome update"
    Value:
      Fn::Sub: "https://${ReonomyUploadApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/"